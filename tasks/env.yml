version: '3'

# Environment & 1Password Management Tasks

tasks:
  # === Public Tasks ===

  generate:
    desc: "Generate .env files from 1Password"
    vars:
      ENV: '{{.ENV | default ""}}'
    cmds:
      - task: _ensure_setup
      - task: _ensure_item
      - task: _generate_envs
        vars:
          ENV: '{{.ENV}}'

  setup:
    desc: "Run 1Password setup wizard"
    cmds:
      - ./scripts/setup-1password.sh
      - |
        echo ""
        echo "Setup complete!"
        echo "Run 'task env' to generate .env files"

  status:
    desc: "Show 1Password and .env file status"
    deps: [_check_op]
    silent: true
    cmds:
      - task: _ensure_setup
      - |
        echo "Environment Status"
        echo "=================="
        if [ -f .1password.yml ]; then
          echo "Configuration:"
          echo "  Repository:   {{.ITEM_NAME}}"
          echo "  Vault:        {{.VAULT}}"
          if [ -n "{{.ACCOUNT}}" ]; then
            echo "  Account:      {{.ACCOUNT}}"
          fi
          echo "  Environments: {{.ENVIRONMENTS}}"
        else
          echo "No configuration found"
          exit 0
        fi

        echo ""
        echo "1Password item: {{.ITEM_NAME}}"

        if op item get "{{.ITEM_NAME}}" --vault="{{.VAULT}}" {{.ACCOUNT_FLAG}} >/dev/null 2>&1; then
          echo "  Status: Exists"
        else
          echo "  Status: Not found (will be created when you run 'task env')"
        fi

        echo ""
        echo "Local .env files:"
        for env in {{.ENVIRONMENTS}}; do
          ENV_FILE=".env.$env"
          if [ -f "$ENV_FILE" ]; then
            echo "  $env: exists"
          else
            echo "  $env: missing"
          fi
        done

  clean:
    desc: "Remove all generated .env files"
    prompt: "Remove all .env.* files?"
    cmds:
      - rm -f .env .env.*
      - echo "Cleaned up all .env files"

  # === Private Tasks ===

  _ensure_setup:
    silent: true
    run: once
    cmds:
      - |
        if [ ! -f .1password.yml ]; then
          echo "First time setup needed"
          echo ""
          task env:setup
        fi

  _ensure_item:
    silent: true
    run: once
    deps: [_check_op]
    cmds:
      - |
        ITEM_NAME="{{.ITEM_NAME}}"
        if ! op item get "$ITEM_NAME" --vault="{{.VAULT}}" {{.ACCOUNT_FLAG}} >/dev/null 2>&1; then
          echo "1Password item '$ITEM_NAME' not found in vault '{{.VAULT}}'"
          echo ""
          echo "Please create the secure note manually in 1Password:"
          echo "  1. Open 1Password"
          echo "  2. Create a new Secure Note named '$ITEM_NAME' in vault '{{.VAULT}}'"
          echo "  3. Add sections for each environment: {{.ENVIRONMENTS}}"
          echo "  4. Add the required fields for each section"
          echo ""
          echo "Then run 'task env' again to generate .env files"
          exit 1
        fi

  _generate_envs:
    deps: [_check_op]
    vars:
      ENV: '{{.ENV | default ""}}'
    cmds:
      - |
        if [ -n "{{.ENV}}" ]; then
          ./scripts/generate-env.sh "{{.ENV}}"
        else
          for env in {{.ENVIRONMENTS}}; do
            ./scripts/generate-env.sh "$env"
          done
        fi

  _check_op:
    silent: true
    preconditions:
      - sh: command -v op >/dev/null 2>&1
        msg: |
          1Password CLI not installed
          Run: brew install 1password-cli
      - sh: command -v yq >/dev/null 2>&1
        msg: |
          yq not installed
          Run: brew install yq
      - sh: op account list >/dev/null 2>&1
        msg: |
          Not signed in to 1Password
          Run: op signin
